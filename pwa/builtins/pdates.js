"use strict";
// auto-generated by pwa/p2js - part of Phix, see http://phix.x10.mx
//
// pdates.e
// ========
//
//   Some support routines for date(), namely day_of_week(), days_in_month(), 
//                                     day_of_year(), and is_leap_year()
//
//   [moved out of pdate.e as that uses #ilASM{}, for pwa/p2js]
//
let /*sequence*/ $dot, $dim, $t, $days;
let /*integer*/ $dinit = 0;
function $initd() {
    $dot = ["sequence",0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
    $dim = ["sequence",31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    $t = ["sequence",-1, 2, 1, 4, -1, 2, 4, 0, 3, 5, 1, 3];
    $days = ["sequence","Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
    $dinit = 1;
}

/*global*/ function is_leap_year(/*integer*/ y) {
    return (equal(remainder(y,4),0)) && ((!equal(remainder(y,100),0)) || (equal(remainder(y,400),0)));
}

/*global*/ function day_of_year(/*integer*/ y, /*integer*/ m, /*integer*/ d) {
// day of year function, returns 1..366
    if (!$dinit) { $initd(); }
    if ((m<1 || m>12) || ((y!==0) && y<1752)) { return 0; }
    return (d+$subse($dot,m))+(m>2 && is_leap_year(y));
}

/*global*/ function days_in_month(/*integer*/ y, /*integer*/ m) {
    if (!$dinit) { $initd(); }
    if ((m<1 || m>12) || ((y!==0) && y<1752)) { return 0; }
    return $subse($dim,m)+((m===2) && is_leap_year(y));
}
/*
function julianDayOfYear(object ymd) -- returns an integer
integer year, month, day
integer d

    year = ymd[1]
    month = ymd[2]
    day = ymd[3]

    if month=1 then return day end if

    d = 0
    for i=1 to month-1 do
        d += daysInMonth(year, i)
    end for

    d += day

    if year=Gregorian_Reformation and month=9 then
        if day>13 then
            d -= 11
        elsif day>2 then
            return 0
        end if
    end if

    return d
end function

*/

/*global*/ function day_of_week(/*integer*/ y, m, d, /*bool*/ bAsText=false) {
// day of week function (Sakamoto) returns 1..7 (Mon..Sun)
    let /*integer*/ l;
    if (!$dinit) { $initd(); }
    if (d<1) { crash("9/0"); }
    if ((((y!==0) || (m!==0)) || !bAsText) || d>7) {
        y -= m<3;
        l = (floor(y/4)-floor(y/100))+floor(y/400);
        d += (y+l)+$subse($t,m);
        d = remainder(d,7)+1;
    }
    if (bAsText) {
        return $subse($days,d);
    }
    return d;
}
