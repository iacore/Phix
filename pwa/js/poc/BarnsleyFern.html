<!DOCTYPE html>
<html lang="en" >
 <head>
  <meta charset='utf-8'/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Barnsley Fern - pwa/p2js</title>
  <link type="text/css" rel="stylesheet" media="screen" href="../../pGUI.css" />
 </head>
 <body>
  <script src="../../p2js.js"></script>
  <script src="../../pGUI.js"></script>
  <script>
// auto-generated by pwa/p2js
//
// pwa\phix\BarnsleyFern.exw
// =========================
//
//include pGUI.e

const CD_DARK_GREEN = "green";

function IupCanvas(action = null, func = null, attributes = "", args = []) {
    let canvas = document.createElement("canvas");
    canvas.setAttribute('class', 'canvas');
    [action,func,attributes,args] = $paranormalise(action,func,attributes,args);
    //DEV/temp...
//  canvas.onload = func; // nope...
//  canvas.onloadstart = func;
//  canvas.onresize = func;
    IupSetAttributes(canvas, attributes, args);
    return canvas;
}
function cdCanvasActivate(ctx) {
    ctx.fillStyle="white";
    ctx.fillRect(0,0,ctx.canvas.clientWidth,ctx.canvas.clientHeight);
}
function cdCanvasPixel(ctx,x,y,clr) {
    ctx.fillStyle = clr;
    ctx.fillRect(x,ctx.canvas.clientHeight-y,1,1);
}
function cdCanvasFlush() {}
function IupMap() {}
const CD_IUP = 1, CD_DBUFFER = 2;
function cdCreateCanvas(context, canvas) {
    if (context===CD_DBUFFER) {
        let ctx = canvas.getContext("2d");
        return ctx;
    }
    return canvas;
}


//function redraw_cb(Ihandle /*canvas*/, integer /*posx*/, integer /*posy*/)
function redraw_cb() {
    let /*atom*/ x = 0, y = 0;
//  let /*integer*/ [,width, height] = IupGetIntInt(canvas, "DRAWSIZE");
let width = canvas.width; // dev/temp...
    cdCanvasActivate(cddbuffer);
    for (let i=1; i<=100000; i+=1) {
        let /*integer*/ r = rand(100);
//      {x, y} = iff(r<=1? {             0,        0.16*y     } :
//               iff(r<=8? { 0.20*x-0.26*y, 0.23*x+0.22*y+1.60} :
//               iff(r<=15?{-0.15*x+0.28*y, 0.26*x+0.24*y+0.44} :
//                         { 0.85*x+0.04*y,-0.04*x+0.85*y+1.60})))
        [,x,y] = (r<=1)? ["sequence",             0,        0.16*y     ] :
                 (r<=8)? ["sequence", 0.20*x-0.26*y, 0.23*x+0.22*y+1.60] :
                 (r<=15)?["sequence",-0.15*x+0.28*y, 0.26*x+0.24*y+0.44] :
                         ["sequence", 0.85*x+0.04*y,-0.04*x+0.85*y+1.60];
//      if (r<=1) {         [,x,y] = ["sequence",             0,        0.16*y     ];
//      } else if (r<=8) {  [,x,y] = ["sequence", 0.20*x-0.26*y, 0.23*x+0.22*y+1.60];
//      } else if (r<=15) { [,x,y] = ["sequence",-0.15*x+0.28*y, 0.26*x+0.24*y+0.44];
//      } else {            [,x,y] = ["sequence", 0.85*x+0.04*y,-0.04*x+0.85*y+1.60];
//      }
        cdCanvasPixel(cddbuffer, width/2+x*50, y*50, CD_DARK_GREEN);
    }
    cdCanvasFlush(cddbuffer);
    return IUP_DEFAULT;
}

let /*Ihandle*/ dlg, canvas;
let /*cdCanvas*/ cddbuffer, cdcanvas;

IupOpen();
canvas = IupCanvas(Icallback(redraw_cb),"RASTERSIZE=340x540");
dlg = IupDialog(canvas,'TITLE="Barnsley Fern"');
//DEV/temp
//dlg.onresize=redraw_cb; //(violation...)

IupMap(dlg);

cdcanvas = cdCreateCanvas(CD_IUP, canvas)
cddbuffer = cdCreateCanvas(CD_DBUFFER, cdcanvas)
//DEV:
IupSetAttribute(canvas, "RASTERSIZE", null); // release the minimum limitation
IupShow(dlg);
//DEV/temp...
redraw_cb();
//if platform()!=JS then
//  IupMainLoop()
//  IupClose()
//end if
  </script>
 </body>
</html>
